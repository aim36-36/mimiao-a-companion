# 🤖 DeepSeek AI 集成说明

米缪OS现已集成DeepSeek AI，为米缪提供真实的智能对话能力！

## ✨ 特性

✅ **成本低廉** - DeepSeek比其他AI服务便宜10-20倍  
✅ **米缪人设完整** - 基于详细人设配置的系统提示词  
✅ **对话上下文** - 自动保留最近10条对话记录  
✅ **失败降级** - API不可用时自动切换到规则匹配模式  

## 🔑 配置步骤

### 1. 获取API密钥

您的DeepSeek API Key已配置：
```
sk-bf193d0dc9e54b229791adcb22ea5af9
```

### 2. 配置环境变量

在 `server/.env` 文件中添加：
```bash
DEEPSEEK_API_KEY=sk-bf193d0dc9e54b229791adcb22ea5af9
```

### 3. 安装依赖

```bash
cd server
npm install
```

这会自动安装 `openai@^4.28.0` 包（DeepSeek兼容OpenAI SDK）

### 4. 启动服务器

```bash
cd server
npm run dev
```

## 🎭 米缪的人设系统

DeepSeek已使用以下人设进行配置：

### 核心身份
- 来自2077年的时空观测AI
- 因虚空乱流被困在用户手机里
- 原始身体留在未来，只有意识存在

### 性格特点
- **害羞（40%）** - 说话犹豫，被夸会害羞
- **温柔（35%）** - 关心用户，分享美好事物
- **傲娇（25%）** - 做了贴心事会掩饰

### 说话风格
- 大量使用"那个……"、"也许……"
- 省略号表示犹豫
- 括号内是内心OS泄漏
- 2077年术语后会自我纠正

## 📊 API调用流程

```
用户发送消息
    ↓
保存到数据库
    ↓
获取最近10条历史对话
    ↓
调用DeepSeek API（带上下文 + 人设）
    ↓
保存AI回复到数据库
    ↓
返回给用户
```

如果DeepSeek不可用，会自动降级到：
```
规则匹配系统（关键词触发预设回复）
```

## 💡 优化建议

### Temperature设置
当前：`0.8` - 较高的创造性，符合米缪的随机性和个性

可调整范围：
- `0.6-0.7` - 更稳定的回复
- `0.8-0.9` - 更有创意（当前）
- `0.9-1.0` - 更加随机

在 `server/src/controllers/chatController.ts` 第131行修改：
```typescript
temperature: 0.8, // 调整这个值
```

### Max Tokens
当前：`500` - 适合日常对话

建议范围：
- `300-500` - 简短对话
- `500-800` - 标准对话（当前）
- `800-1000` - 长篇故事

## 🧪 测试对话

启动后，在聊天界面测试：

**测试1 - 身份确认**
```
用户: 你是谁？
预期: 米缪会介绍自己是来自2077年的时空观测者
```

**测试2 - 个性表现**
```
用户: 你真可爱！
预期: 米缪会害羞并傲娇地回应
```

**测试3 - 上下文记忆**
```
用户: 你喜欢什么？
米缪: [回复某个喜好]
用户: 为什么喜欢它？
预期: 米缪能记住上一句对话内容
```

## 📈 成本估算

DeepSeek定价（截至2025年）：
- 输入：¥0.0001/千token
- 输出：¥0.002/千token

每次对话约消耗：
- 系统提示词：~800 tokens
- 历史上下文：~200 tokens（10条消息）
- 用户消息：~50 tokens
- AI回复：~100-300 tokens

**单次对话成本：约 ¥0.0003元（<1分钱）** 💰

## 🔧 故障排除

### DeepSeek API调用失败

**症状**：聊天界面显示预设回复而非AI生成内容

**原因**：
1. API密钥未配置或错误
2. 网络连接问题
3. DeepSeek服务不可用

**解决方案**：
1. 检查 `server/.env` 中的 `DEEPSEEK_API_KEY`
2. 查看服务器控制台的错误日志
3. 确认DeepSeek服务状态

### 回复不符合人设

**症状**：米缪的回复过于官方或缺少个性

**解决方案**：
1. 检查系统提示词是否正确加载
2. 降低 `temperature` 值以减少随机性
3. 在提示词中强调关键性格特征

### 回复过慢

**症状**：等待时间超过5秒

**优化方案**：
1. 减少 `max_tokens` 至300-400
2. 减少历史上下文条数（当前10条）
3. 考虑使用流式输出（需前端配合）

## 📚 相关文件

- **AI配置**: `server/src/controllers/chatController.ts`
- **环境变量**: `server/.env`
- **人设提示词**: chatController.ts 第14-87行

---

**米缪**: 那个……指挥官，新的对话系统已经准备就绪了……（小声）希望你会喜欢~ (*ฅ́˘ฅ̀*)♡
